name: Smoke Test

on:
  schedule:
    - cron: '0 4 * * 1' # Mondays at 05:00 UTC
  workflow_dispatch:

env:
  JAVA_VERSION: '21'
  # Test client credentials (these are demo/test values already present in the codebase)
  TEST_CLIENT_ID: 'm2m-client'
  TEST_CLIENT_SECRET: 'm2m-secret'

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '9.0.0'

      - name: Build application JAR
        run: gradle :server-ui:bootJar -x test --no-daemon --build-cache --parallel

      - name: Start Docker Compose environment
        run: |
          docker compose up -d --build --wait
          echo "All services are healthy."

      - name: Show OAuth2 server health status
        run: |
          echo "OAuth2 server health status:"
          curl -s http://localhost:9000/actuator/health | jq .

      - name: Run smoke tests
        id: smoke-tests
        run: |
          mkdir -p build/smoke-test-results
          
          echo "=== Smoke Test Results ===" > build/smoke-test-results/smoke-test-report.txt
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> build/smoke-test-results/smoke-test-report.txt
          echo "" >> build/smoke-test-results/smoke-test-report.txt
          
          TESTS_PASSED=0
          TESTS_FAILED=0
          
          # Test 1: Health endpoint
          echo "Test 1: Health Endpoint" >> build/smoke-test-results/smoke-test-report.txt
          if HEALTH_RESPONSE=$(curl -sf http://localhost:9000/actuator/health); then
            echo "  Status: PASSED" >> build/smoke-test-results/smoke-test-report.txt
            echo "  Response: $HEALTH_RESPONSE" >> build/smoke-test-results/smoke-test-report.txt
            ((TESTS_PASSED++)) || true
          else
            echo "  Status: FAILED" >> build/smoke-test-results/smoke-test-report.txt
            ((TESTS_FAILED++)) || true
          fi
          echo "" >> build/smoke-test-results/smoke-test-report.txt
          
          # Test 2: Liveness probe
          echo "Test 2: Liveness Probe" >> build/smoke-test-results/smoke-test-report.txt
          if curl -sf http://localhost:9000/actuator/health/liveness > /dev/null; then
            echo "  Status: PASSED" >> build/smoke-test-results/smoke-test-report.txt
            ((TESTS_PASSED++)) || true
          else
            echo "  Status: FAILED" >> build/smoke-test-results/smoke-test-report.txt
            ((TESTS_FAILED++)) || true
          fi
          echo "" >> build/smoke-test-results/smoke-test-report.txt
          
          # Test 3: Readiness probe
          echo "Test 3: Readiness Probe" >> build/smoke-test-results/smoke-test-report.txt
          if curl -sf http://localhost:9000/actuator/health/readiness > /dev/null; then
            echo "  Status: PASSED" >> build/smoke-test-results/smoke-test-report.txt
            ((TESTS_PASSED++)) || true
          else
            echo "  Status: FAILED" >> build/smoke-test-results/smoke-test-report.txt
            ((TESTS_FAILED++)) || true
          fi
          echo "" >> build/smoke-test-results/smoke-test-report.txt
          
          # Test 4: OIDC Discovery endpoint
          echo "Test 4: OIDC Discovery Endpoint" >> build/smoke-test-results/smoke-test-report.txt
          if OIDC_RESPONSE=$(curl -sf http://localhost:9000/.well-known/openid-configuration); then
            echo "  Status: PASSED" >> build/smoke-test-results/smoke-test-report.txt
            echo "  Issuer: $(echo $OIDC_RESPONSE | jq -r '.issuer')" >> build/smoke-test-results/smoke-test-report.txt
            ((TESTS_PASSED++)) || true
          else
            echo "  Status: FAILED" >> build/smoke-test-results/smoke-test-report.txt
            ((TESTS_FAILED++)) || true
          fi
          echo "" >> build/smoke-test-results/smoke-test-report.txt
          
          # Test 5: JWKS endpoint
          echo "Test 5: JWKS Endpoint" >> build/smoke-test-results/smoke-test-report.txt
          if JWKS_RESPONSE=$(curl -sf http://localhost:9000/oauth2/jwks); then
            echo "  Status: PASSED" >> build/smoke-test-results/smoke-test-report.txt
            KEYS_COUNT=$(echo $JWKS_RESPONSE | jq '.keys | length')
            echo "  Keys count: $KEYS_COUNT" >> build/smoke-test-results/smoke-test-report.txt
            ((TESTS_PASSED++)) || true
          else
            echo "  Status: FAILED" >> build/smoke-test-results/smoke-test-report.txt
            ((TESTS_FAILED++)) || true
          fi
          echo "" >> build/smoke-test-results/smoke-test-report.txt
          
          # Test 6: Client Credentials token request
          echo "Test 6: Client Credentials Token Request" >> build/smoke-test-results/smoke-test-report.txt
          if TOKEN_RESPONSE=$(curl -sf -X POST http://localhost:9000/oauth2/token \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -u "$TEST_CLIENT_ID:$TEST_CLIENT_SECRET" \
            -d "grant_type=client_credentials&scope=api:read"); then
            echo "  Status: PASSED" >> build/smoke-test-results/smoke-test-report.txt
            TOKEN_TYPE=$(echo $TOKEN_RESPONSE | jq -r '.token_type')
            EXPIRES_IN=$(echo $TOKEN_RESPONSE | jq -r '.expires_in')
            echo "  Token type: $TOKEN_TYPE" >> build/smoke-test-results/smoke-test-report.txt
            echo "  Expires in: $EXPIRES_IN seconds" >> build/smoke-test-results/smoke-test-report.txt
            
            # Save access token for introspection test
            ACCESS_TOKEN=$(echo $TOKEN_RESPONSE | jq -r '.access_token')
            ((TESTS_PASSED++)) || true
          else
            echo "  Status: FAILED" >> build/smoke-test-results/smoke-test-report.txt
            ((TESTS_FAILED++)) || true
          fi
          echo "" >> build/smoke-test-results/smoke-test-report.txt
          
          # Test 7: Token introspection (only if token was obtained)
          echo "Test 7: Token Introspection" >> build/smoke-test-results/smoke-test-report.txt
          if [ -n "$ACCESS_TOKEN" ]; then
            if INTROSPECT_RESPONSE=$(curl -sf -X POST http://localhost:9000/oauth2/introspect \
              -H "Content-Type: application/x-www-form-urlencoded" \
              -u "$TEST_CLIENT_ID:$TEST_CLIENT_SECRET" \
              -d "token=$ACCESS_TOKEN"); then
              ACTIVE=$(echo $INTROSPECT_RESPONSE | jq -r '.active')
              if [ "$ACTIVE" = "true" ]; then
                echo "  Status: PASSED" >> build/smoke-test-results/smoke-test-report.txt
                echo "  Token active: $ACTIVE" >> build/smoke-test-results/smoke-test-report.txt
                ((TESTS_PASSED++)) || true
              else
                echo "  Status: FAILED (token not active)" >> build/smoke-test-results/smoke-test-report.txt
                ((TESTS_FAILED++)) || true
              fi
            else
              echo "  Status: FAILED" >> build/smoke-test-results/smoke-test-report.txt
              ((TESTS_FAILED++)) || true
            fi
          else
            echo "  Status: SKIPPED (no token available)" >> build/smoke-test-results/smoke-test-report.txt
          fi
          echo "" >> build/smoke-test-results/smoke-test-report.txt
          
          # Test 8: Prometheus metrics endpoint
          echo "Test 8: Prometheus Metrics Endpoint" >> build/smoke-test-results/smoke-test-report.txt
          if curl -sf http://localhost:9000/actuator/prometheus > /dev/null; then
            echo "  Status: PASSED" >> build/smoke-test-results/smoke-test-report.txt
            ((TESTS_PASSED++)) || true
          else
            echo "  Status: FAILED" >> build/smoke-test-results/smoke-test-report.txt
            ((TESTS_FAILED++)) || true
          fi
          echo "" >> build/smoke-test-results/smoke-test-report.txt
          
          # Summary
          echo "=== Summary ===" >> build/smoke-test-results/smoke-test-report.txt
          echo "Tests Passed: $TESTS_PASSED" >> build/smoke-test-results/smoke-test-report.txt
          echo "Tests Failed: $TESTS_FAILED" >> build/smoke-test-results/smoke-test-report.txt
          TOTAL_TESTS=$((TESTS_PASSED + TESTS_FAILED))
          echo "Total Tests: $TOTAL_TESTS" >> build/smoke-test-results/smoke-test-report.txt
          
          # Output for GitHub Actions
          echo "tests_passed=$TESTS_PASSED" >> $GITHUB_OUTPUT
          echo "tests_failed=$TESTS_FAILED" >> $GITHUB_OUTPUT
          
          # Display report
          cat build/smoke-test-results/smoke-test-report.txt
          
          # Fail if any tests failed
          if [ $TESTS_FAILED -gt 0 ]; then
            echo "::error::$TESTS_FAILED smoke test(s) failed"
            exit 1
          fi

      - name: Collect Docker logs
        if: always()
        run: |
          mkdir -p build/smoke-test-results/docker-logs
          docker compose logs oauth2-server > build/smoke-test-results/docker-logs/oauth2-server.log 2>&1 || true
          docker compose logs postgres > build/smoke-test-results/docker-logs/postgres.log 2>&1 || true
          docker compose logs otel-collector > build/smoke-test-results/docker-logs/otel-collector.log 2>&1 || true

      - name: Stop Docker Compose environment
        if: always()
        run: docker compose down -v

      - name: Upload smoke test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-test-results
          path: build/smoke-test-results/
