micronaut:
  application:
    name: profile-ui
  server:
    port: ${SERVER_PORT:8080}
  router:
    static-resources:
      public:
        enabled: true
        paths: classpath:public
        mapping: /**
      js:
        enabled: true
        paths: classpath:public
        mapping: /profile-app.js
  security:
    enabled: true
    # JWT validation is handled by Istio - we only read headers
    # authentication: bearer (disabled - using IstioHeaderAuthenticationProvider)
    redirect:
      enabled: false
    reject-not-found: false
    ip-patterns:
      - 127.0.0.1
    # JWT validation disabled - Istio handles it and passes headers:
    # x-jwt-sub, x-jwt-username, x-jwt-email, x-jwt-name, x-jwt-scope
    # token:
    #   jwt:
    #     signatures:
    #       jwks:
    #         oauth2server:
    #           url: ${OAUTH2_JWKS_URI:https://oauth2.cat-herding.net/oauth2/jwks}
    intercept-url-map:
      - pattern: /api/status
        http-method: GET
        access:
          - isAnonymous()
      - pattern: /profile-app.js
        access:
          - isAnonymous()
      - pattern: /favicon.ico
        access:
          - isAnonymous()
      - pattern: /index.html
        access:
          - isAnonymous()
      - pattern: /public/**
        http-method: GET
        access:
          - isAnonymous()
      - pattern: /actuator/health
        http-method: GET
        access:
          - isAnonymous()
      - pattern: /actuator/prometheus
        http-method: GET
        access:
          - isAnonymous()
      - pattern: /api/me
        http-method: GET
        access:
          - isAuthenticated()
      - pattern: /api/profile
        http-method: GET
        access:
          - isAuthenticated()
      - pattern: /api/profile
        http-method: POST
        access:
          - isAuthenticated()
      - pattern: /api/profile
        http-method: PUT
        access:
          - isAuthenticated()
      - pattern: /api/profile
        http-method: DELETE
        access:
          - isAuthenticated()
      - pattern: /api/admin/**
        access:
          - isAuthenticated()
      - pattern: /**
        access:
          - isAuthenticated()
    # OAuth2 client disabled - using bearer token auth only
    # oauth2:
    #   clients:
    #     oauth2server:
    #       client-id: ${OAUTH2_CLIENT_ID:profile-ui}
    #       client-secret: ${OAUTH2_CLIENT_SECRET:}
    #       openid:
    #         issuer: ${OAUTH2_ISSUER_URI:https://oauth2.cat-herding.net}
    #       authorization:
    #         url: ${OAUTH2_AUTHORIZATION_URL:}
    #       token:
    #         url: ${OAUTH2_TOKEN_URL:}
    #       scopes:
    #         - openid
    #         - profile
    #         - email
    #         - profile:read
    #         - profile:write
    #         - profile:admin
  metrics:
    enabled: true
  export:
    prometheus:
      enabled: true

redis:
  uri: ${REDIS_URI:redis://redis:6379}

auth:
  events:
    consumer:
      enabled: ${AUTH_EVENTS_CONSUMER_ENABLED:false}
      stream: ${AUTH_EVENTS_STREAM:auth:events}
      group: ${AUTH_EVENTS_CONSUMER_GROUP:profile-service}
      consumer-name: ${AUTH_EVENTS_CONSUMER_NAME:profile-service-1}
      batch-size: ${AUTH_EVENTS_BATCH_SIZE:10}
      poll-interval: ${AUTH_EVENTS_POLL_INTERVAL:5s}
      create-group: ${AUTH_EVENTS_CREATE_GROUP:true}

# MongoDB/CosmosDB Configuration
mongodb:
  uri: ${MONGODB_URI:mongodb://localhost:27017}
  database: ${MONGODB_DATABASE:profile-db}
  collection:
    profiles: profiles

endpoints:
  all:
    sensitive: false
  health:
    enabled: true
    details-visible: ANONYMOUS
  prometheus:
    enabled: true
