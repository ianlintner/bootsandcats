apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: ${APP}-oauth2-exchange
  namespace: default
  labels:
    app.kubernetes.io/managed-by: kustomize
    project: bootsandcats
spec:
  workloadSelector:
    labels:
      app: ${APP}
  configPatches:
  - applyTo: CLUSTER
    match:
      context: ANY
    patch:
      operation: ADD
      value:
        name: oauth2_token_cluster_${APP}
        type: STRICT_DNS
        connect_timeout: 5s
        lb_policy: ROUND_ROBIN
        load_assignment:
          cluster_name: oauth2_token_cluster_${APP}
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: oauth2-server.default.svc.cluster.local
                    port_value: 8080
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: envoy.filters.http.oauth2
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.http.oauth2.v3.OAuth2
          config:
            stat_prefix: ${STAT_PREFIX}
            authorization_endpoint: ${AUTHORIZATION_ENDPOINT}
            token_endpoint:
              cluster: oauth2_token_cluster_${APP}
              uri: ${TOKEN_ENDPOINT_URI}
              timeout: 5s
            redirect_uri: "%REQ(x-forwarded-proto)%://%REQ(:authority)%/_oauth2/callback"
            redirect_path_matcher:
              path:
                # NOTE: Envoy matches against the full ":path" header which can include the query string.
                # Use prefix matching so /_oauth2/callback?code=...&state=... is handled by the OAuth2 filter.
                prefix: /_oauth2/callback
            signout_path:
              path:
                prefix: /_oauth2/logout
            forward_bearer_token: true
            default_expires_in: 900s
            csrf_token_expires_in: 600s
            credentials:
              client_id: ${CLIENT_ID}
              token_secret:
                name: ${APP}-oauth-token
                sds_config:
                  path: /etc/istio/oauth2/${APP}-oauth-token.yaml
              hmac_secret:
                name: ${APP}-oauth-hmac
                sds_config:
                  path: /etc/istio/oauth2/${APP}-oauth-hmac.yaml
              cookie_names:
                bearer_token: "_${COOKIE_PREFIX}_session"
                oauth_hmac: "_${COOKIE_PREFIX}_oauth_hmac"
                oauth_expires: "_${COOKIE_PREFIX}_oauth_expires"
            cookie_configs:
              bearer_token_cookie_config:
                same_site: LAX
              oauth_hmac_cookie_config:
                same_site: LAX
              oauth_expires_cookie_config:
                same_site: LAX
            auth_scopes:
            - openid
            - profile
            - email
            pass_through_matcher:
            - name: ":path"
              prefix_match: "/actuator"
            - name: ":path"
              exact_match: "/health"
            - name: ":path"
              exact_match: "/healthz"
            - name: ":path"
              exact_match: "/ready"
            - name: ":path"
              prefix_match: "/api/status"
            - name: ":path"
              prefix_match: "/public/"
            - name: ":path"
              prefix_match: "/css/"
            - name: ":path"
              prefix_match: "/js/"
            - name: ":path"
              prefix_match: "/images/"
            - name: ":path"
              prefix_match: "/webjars/"
            - name: ":path"
              exact_match: "/favicon.ico"
            - name: ":path"
              exact_match: "/profile-app.js"
            - name: ":path"
              exact_match: "/index.html"
            - name: ":path"
              prefix_match: "/swagger"
            - name: ":path"
              prefix_match: "/openapi"
