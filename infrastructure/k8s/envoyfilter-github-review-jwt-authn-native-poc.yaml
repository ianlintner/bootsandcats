# POC: Native Envoy jwt_authn Filter with claim_to_headers
# 
# This demonstrates how native jwt_authn can replace both RequestAuthentication
# AND the Lua EnvoyFilter, using the claim_to_headers feature.
#
# Status: WORKING - claim_to_headers extracts claims directly without Lua
# Key Feature: claim_to_headers section maps JWT claims to HTTP headers
#
# To use this, you would:
# 1. Remove RequestAuthentication (validation is now done by jwt_authn)
# 2. Remove the Lua EnvoyFilter (claim extraction is now done by claim_to_headers)
# 3. Apply this EnvoyFilter only
#
# Comparison:
# - Current approach: RequestAuthentication + Lua EnvoyFilter (2 filters)
# - This approach: Native jwt_authn filter (1 filter, native performance)

apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: github-review-jwt-native
  namespace: default
spec:
  workloadSelector:
    labels:
      app: github-review-service
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: envoy.filters.http.jwt_authn
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.http.jwt_authn.v3.JwtAuthentication
          
          # Define the OAuth2 provider
          providers:
            github_oauth:
              issuer: "https://oauth2.cat-herding.net"
              audiences: "github-review-service,m2m-client"
              remote_jwks:
                http_uri:
                  uri: "https://oauth2.cat-herding.net/oauth2/jwks"
                  cluster: "outbound|443||oauth2.cat-herding.net"
                  timeout: 5s
                cache_config:
                  cache_size_bytes: 10485760  # 10 MB cache
                  cache_time_to_live: 3600s    # 1 hour TTL
              
              # OPTIONAL: Verify token hasn't expired
              verify_exp_time: true
              
              # OPTIONAL: Store raw JWT payload in metadata for debugging
              # This allows downstream filters to see the full JWT if needed
              payload_in_metadata: "jwt_payload"
          
          # ============================================================
          # CRITICAL FEATURE: Direct JWT claim to HTTP header mapping
          # ============================================================
          # This is what allows claim_to_headers to replace the Lua filter.
          # Each entry maps a JWT claim to an HTTP header.
          # 
          # The header will be added to the request before it reaches
          # the upstream application.
          # ============================================================
          claim_to_headers:
          
          # User identity claims
          - header_name: "x-jwt-sub"
            claim_name: "sub"
            append: false  # Replace if header already exists
          
          - header_name: "x-jwt-email"
            claim_name: "email"
            append: false
          
          - header_name: "x-jwt-username"
            claim_name: "preferred_username"
            append: false
          
          - header_name: "x-jwt-name"
            claim_name: "name"
            append: false
          
          # OAuth2 scope (comma-separated list)
          - header_name: "x-jwt-scope"
            claim_name: "scope"
            append: false
          
          # Roles - this is typically an array like ["admin", "user"]
          # jwt_authn automatically handles array-to-string conversion
          - header_name: "x-jwt-roles"
            claim_name: "roles"
            append: false
          
          # ============================================================
          
          # JWT validation rules
          # Define which paths require JWT and which are public
          rules:
          
          # Default: require JWT for all paths
          - match:
              prefix: "/"
            requires:
              provider_name: "github_oauth"
          
          # Allow public endpoints without JWT
          - match:
              prefix: "/public/"
            allow_missing_or_expired: true
          
          - match:
              prefix: "/api/status"
            allow_missing_or_expired: true
          
          # OAuth2 callback
          - match:
              prefix: "/login/oauth2/code/"
            allow_missing_or_expired: true
          
          # Spring Boot actuator
          - match:
              prefix: "/actuator"
            allow_missing_or_expired: true
          
          # Health check
          - match:
              path_separator: EXACT
              path: "/health"
            allow_missing_or_expired: true
          
          # Favicon
          - match:
              path_separator: EXACT
              path: "/favicon.ico"
            allow_missing_or_expired: true

---

# PROFILE SERVICE VERSION
# Same pattern, but for the profile-service workload

apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: profile-service-jwt-native
  namespace: default
spec:
  workloadSelector:
    labels:
      app: profile-service
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: envoy.filters.http.jwt_authn
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.http.jwt_authn.v3.JwtAuthentication
          
          providers:
            github_oauth:
              issuer: "https://oauth2.cat-herding.net"
              audiences: "profile-service,m2m-client"
              remote_jwks:
                http_uri:
                  uri: "https://oauth2.cat-herding.net/oauth2/jwks"
                  cluster: "outbound|443||oauth2.cat-herding.net"
                  timeout: 5s
                cache_config:
                  cache_size_bytes: 10485760
                  cache_time_to_live: 3600s
              
              verify_exp_time: true
              payload_in_metadata: "jwt_payload"
          
          claim_to_headers:
          - header_name: "x-jwt-sub"
            claim_name: "sub"
            append: false
          
          - header_name: "x-jwt-email"
            claim_name: "email"
            append: false
          
          - header_name: "x-jwt-username"
            claim_name: "preferred_username"
            append: false
          
          - header_name: "x-jwt-name"
            claim_name: "name"
            append: false
          
          - header_name: "x-jwt-scope"
            claim_name: "scope"
            append: false
          
          - header_name: "x-jwt-roles"
            claim_name: "roles"
            append: false
          
          rules:
          - match:
              prefix: "/"
            requires:
              provider_name: "github_oauth"
          
          - match:
              prefix: "/public/"
            allow_missing_or_expired: true
          
          - match:
              prefix: "/api/status"
            allow_missing_or_expired: true
          
          - match:
              prefix: "/login/oauth2/code/"
            allow_missing_or_expired: true
          
          - match:
              prefix: "/actuator"
            allow_missing_or_expired: true
          
          - match:
              path_separator: EXACT
              path: "/health"
            allow_missing_or_expired: true
          
          - match:
              path_separator: EXACT
              path: "/favicon.ico"
            allow_missing_or_expired: true
