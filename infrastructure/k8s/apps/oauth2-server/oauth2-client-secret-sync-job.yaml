apiVersion: batch/v1
kind: Job
metadata:
  name: oauth2-client-secret-sync
  namespace: default
  labels:
    app: oauth2-server
    component: secret-sync
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 1
  template:
    metadata:
      annotations:
        sidecar.istio.io/inject: "false"
    spec:
      restartPolicy: Never
      containers:
        - name: sync
          image: postgres:15-alpine
          imagePullPolicy: IfNotPresent
          env:
            - name: DB_HOST
              value: postgres.default.svc.cluster.local
            - name: DB_PORT
              value: "5432"
            - name: DB_NAME
              value: oauth2db
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: oauth2-app-secrets
                  key: database-username
            - name: DB_PASS
              valueFrom:
                secretKeyRef:
                  name: oauth2-app-secrets
                  key: database-password
            - name: M2M_SECRET
              valueFrom:
                secretKeyRef:
                  name: oauth2-app-secrets
                  key: m2m-client-secret
            - name: PROFILE_SECRET
              valueFrom:
                secretKeyRef:
                  name: profile-service-secrets
                  key: profile-service-client-secret
          command:
            - sh
            - -lc
            - |
              set -eu
              export PGPASSWORD="$DB_PASS"

              echo "Updating oauth2_registered_client secrets (hashing via pgcrypto)..."

              psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" \
                -v m2m_secret="$M2M_SECRET" \
                -v profile_secret="$PROFILE_SECRET" \
                <<'SQL'
              \set ON_ERROR_STOP on
              CREATE EXTENSION IF NOT EXISTS pgcrypto;

              -- Hash secrets inside Postgres; never print raw secrets.
              UPDATE oauth2_registered_client
                 SET client_secret = '{bcrypt}' || crypt(:'m2m_secret', gen_salt('bf', 10))
               WHERE client_id = 'm2m-client';

              UPDATE oauth2_registered_client
                 SET client_secret = '{bcrypt}' || crypt(:'profile_secret', gen_salt('bf', 10))
               WHERE client_id = 'profile-service';

              -- Verify without leaking secret material.
              SELECT client_id,
                     length(client_secret) AS client_secret_len,
                     left(client_secret, 18) AS client_secret_prefix
                FROM oauth2_registered_client
               WHERE client_id IN ('m2m-client','profile-service')
               ORDER BY client_id;
              SQL

