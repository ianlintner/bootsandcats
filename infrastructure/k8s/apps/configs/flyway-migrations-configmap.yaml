apiVersion: v1
kind: ConfigMap
metadata:
  name: flyway-migrations
  namespace: default
  labels:
    app: oauth2-server
    component: database-migrations
data:
  V1__create_app_users_table.sql: |
    -- Create app_users table for federated identity users
    CREATE TABLE IF NOT EXISTS app_users (
        id BIGSERIAL PRIMARY KEY,
        username VARCHAR(255),
        email VARCHAR(255),
        provider VARCHAR(100) NOT NULL,
        provider_id VARCHAR(255) NOT NULL,
        name VARCHAR(255),
        picture_url TEXT,
        last_login TIMESTAMP,
        CONSTRAINT uq_provider_provider_id UNIQUE (provider, provider_id)
    );

    CREATE INDEX IF NOT EXISTS idx_app_users_email ON app_users(email);
    CREATE INDEX IF NOT EXISTS idx_app_users_username ON app_users(username);

  V2__create_oauth2_registered_client_table.sql: |
    CREATE TABLE IF NOT EXISTS oauth2_registered_client (
        id VARCHAR(100) PRIMARY KEY,
        client_id VARCHAR(100) NOT NULL UNIQUE,
        client_id_issued_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
        client_secret VARCHAR(200),
        client_secret_expires_at TIMESTAMP WITH TIME ZONE,
        client_name VARCHAR(200) NOT NULL,
        client_authentication_methods TEXT NOT NULL,
        authorization_grant_types TEXT NOT NULL,
        redirect_uris TEXT,
        post_logout_redirect_uris TEXT,
        scopes TEXT NOT NULL,
        client_settings TEXT NOT NULL,
        token_settings TEXT NOT NULL
    );

  V3__create_security_audit_table.sql: |
    -- Create security_audit_events table for compliance audit logging
    CREATE TABLE IF NOT EXISTS security_audit_events (
        id BIGSERIAL PRIMARY KEY,
        event_id UUID NOT NULL UNIQUE,
        event_type VARCHAR(100) NOT NULL,
        event_category VARCHAR(50) NOT NULL,
        event_timestamp TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
        
        -- Actor information
        principal VARCHAR(255),
        principal_type VARCHAR(50),
        user_id BIGINT,
        client_id VARCHAR(100),
        
        -- Request context
        ip_address VARCHAR(45),
        user_agent TEXT,
        request_uri TEXT,
        request_method VARCHAR(10),
        session_id VARCHAR(255),
        correlation_id VARCHAR(100),
        
        -- Event details
        result VARCHAR(20) NOT NULL,
        result_code VARCHAR(50),
        error_message TEXT,
        
        -- OAuth2 specific fields
        grant_type VARCHAR(50),
        scopes TEXT,
        token_type VARCHAR(50),
        authorization_code_id VARCHAR(255),
        
        -- Additional metadata as JSON
        details JSONB,
        
        -- Timestamps
        created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP
    );

    -- Performance indexes for common query patterns
    CREATE INDEX IF NOT EXISTS idx_audit_event_type ON security_audit_events(event_type);
    CREATE INDEX IF NOT EXISTS idx_audit_event_category ON security_audit_events(event_category);
    CREATE INDEX IF NOT EXISTS idx_audit_event_timestamp ON security_audit_events(event_timestamp);
    CREATE INDEX IF NOT EXISTS idx_audit_principal ON security_audit_events(principal);
    CREATE INDEX IF NOT EXISTS idx_audit_client_id ON security_audit_events(client_id);
    CREATE INDEX IF NOT EXISTS idx_audit_user_id ON security_audit_events(user_id);
    CREATE INDEX IF NOT EXISTS idx_audit_result ON security_audit_events(result);
    CREATE INDEX IF NOT EXISTS idx_audit_ip_address ON security_audit_events(ip_address);
    CREATE INDEX IF NOT EXISTS idx_audit_session_id ON security_audit_events(session_id);
    CREATE INDEX IF NOT EXISTS idx_audit_correlation_id ON security_audit_events(correlation_id);

    -- Composite index for time-range queries with filtering
    CREATE INDEX IF NOT EXISTS idx_audit_timestamp_type ON security_audit_events(event_timestamp, event_type);
    CREATE INDEX IF NOT EXISTS idx_audit_timestamp_principal ON security_audit_events(event_timestamp, principal);

    -- GIN index for JSON details field queries
    CREATE INDEX IF NOT EXISTS idx_audit_details ON security_audit_events USING GIN (details);

    -- Comment for documentation
    COMMENT ON TABLE security_audit_events IS 'Security audit log for OAuth2 compliance tracking';
    COMMENT ON COLUMN security_audit_events.event_id IS 'Unique identifier for the audit event (UUID)';
    COMMENT ON COLUMN security_audit_events.event_type IS 'Type of security event (e.g., LOGIN_SUCCESS, TOKEN_ISSUED)';
    COMMENT ON COLUMN security_audit_events.event_category IS 'Category grouping (e.g., AUTHENTICATION, TOKEN, AUTHORIZATION)';
    COMMENT ON COLUMN security_audit_events.result IS 'Event outcome: SUCCESS, FAILURE, DENIED';
    COMMENT ON COLUMN security_audit_events.details IS 'Additional event-specific metadata as JSON';

  V4__create_oauth2_authorization_tables.sql: |
    -- OAuth2 Authorization Table
    -- Stores authorization information (codes, tokens, etc.)
    CREATE TABLE IF NOT EXISTS oauth2_authorization (
        id VARCHAR(100) PRIMARY KEY,
        registered_client_id VARCHAR(100) NOT NULL,
        principal_name VARCHAR(200) NOT NULL,
        authorization_grant_type VARCHAR(100) NOT NULL,
        authorized_scopes TEXT,
        attributes TEXT,
        state VARCHAR(500),
        authorization_code_value TEXT,
        authorization_code_issued_at TIMESTAMP WITH TIME ZONE,
        authorization_code_expires_at TIMESTAMP WITH TIME ZONE,
        authorization_code_metadata TEXT,
        access_token_value TEXT,
        access_token_issued_at TIMESTAMP WITH TIME ZONE,
        access_token_expires_at TIMESTAMP WITH TIME ZONE,
        access_token_metadata TEXT,
        access_token_type VARCHAR(100),
        access_token_scopes TEXT,
        oidc_id_token_value TEXT,
        oidc_id_token_issued_at TIMESTAMP WITH TIME ZONE,
        oidc_id_token_expires_at TIMESTAMP WITH TIME ZONE,
        oidc_id_token_metadata TEXT,
        refresh_token_value TEXT,
        refresh_token_issued_at TIMESTAMP WITH TIME ZONE,
        refresh_token_expires_at TIMESTAMP WITH TIME ZONE,
        refresh_token_metadata TEXT,
        user_code_value TEXT,
        user_code_issued_at TIMESTAMP WITH TIME ZONE,
        user_code_expires_at TIMESTAMP WITH TIME ZONE,
        user_code_metadata TEXT,
        device_code_value TEXT,
        device_code_issued_at TIMESTAMP WITH TIME ZONE,
        device_code_expires_at TIMESTAMP WITH TIME ZONE,
        device_code_metadata TEXT,
        CONSTRAINT fk_oauth2_authorization_client 
            FOREIGN KEY (registered_client_id) REFERENCES oauth2_registered_client(id)
    );

    -- OAuth2 Authorization Consent Table
    -- Stores user consent for OAuth2 clients
    CREATE TABLE IF NOT EXISTS oauth2_authorization_consent (
        registered_client_id VARCHAR(100) NOT NULL,
        principal_name VARCHAR(200) NOT NULL,
        authorities TEXT NOT NULL,
        PRIMARY KEY (registered_client_id, principal_name),
        CONSTRAINT fk_oauth2_consent_client 
            FOREIGN KEY (registered_client_id) REFERENCES oauth2_registered_client(id)
    );

    -- Create indexes for common query patterns
    CREATE INDEX IF NOT EXISTS idx_oauth2_authorization_principal ON oauth2_authorization(principal_name);
    CREATE INDEX IF NOT EXISTS idx_oauth2_authorization_client ON oauth2_authorization(registered_client_id);
    CREATE INDEX IF NOT EXISTS idx_oauth2_authorization_state ON oauth2_authorization(state);

  V5__add_profile_ui_client.sql: |
    -- Add profile-ui client with profile scopes
    -- This client is used by the Profile UI application for managing user profiles

    -- Use INSERT ... ON CONFLICT to handle both id and client_id conflicts
    INSERT INTO oauth2_registered_client (
        id, 
        client_id, 
        client_id_issued_at, 
        client_secret, 
        client_secret_expires_at, 
        client_name, 
        client_authentication_methods, 
        authorization_grant_types, 
        redirect_uris, 
        post_logout_redirect_uris, 
        scopes, 
        client_settings, 
        token_settings
    ) VALUES (
        'profile-ui-client-001', 
        'profile-ui', 
        CURRENT_TIMESTAMP, 
        NULL,  -- Public client, no secret (uses PKCE)
        NULL, 
        'Profile UI Application', 
        'none',  -- Public client
        'authorization_code,refresh_token', 
        'http://localhost:8082/oauth/callback,http://localhost:8082/,https://profile-ui.example.com/oauth/callback', 
        'http://localhost:8082/,https://profile-ui.example.com/', 
        'openid,profile,email,profile:read,profile:write', 
            '{"@class":"java.util.Collections$UnmodifiableMap","settings.client.require-proof-key":true,"settings.client.require-authorization-consent":true}', 
            '{"@class":"java.util.Collections$UnmodifiableMap","settings.token.reuse-refresh-tokens":true,"settings.token.id-token-signature-algorithm":["org.springframework.security.oauth2.jose.jws.SignatureAlgorithm","ES256"],"settings.token.access-token-time-to-live":["java.time.Duration",3600.000000000],"settings.token.access-token-format":{"@class":"org.springframework.security.oauth2.server.authorization.settings.OAuth2TokenFormat","value":"self-contained"},"settings.token.refresh-token-time-to-live":["java.time.Duration",86400.000000000],"settings.token.authorization-code-time-to-live":["java.time.Duration",300.000000000]}'
    ) ON CONFLICT (client_id) DO UPDATE SET 
        scopes = EXCLUDED.scopes,
        redirect_uris = EXCLUDED.redirect_uris,
        post_logout_redirect_uris = EXCLUDED.post_logout_redirect_uris;

    -- Also add an admin client for admin users
    INSERT INTO oauth2_registered_client (
        id, 
        client_id, 
        client_id_issued_at, 
        client_secret, 
        client_secret_expires_at, 
        client_name, 
        client_authentication_methods, 
        authorization_grant_types, 
        redirect_uris, 
        post_logout_redirect_uris, 
        scopes, 
        client_settings, 
        token_settings
    ) VALUES (
        'profile-admin-client-001', 
        'profile-admin', 
        CURRENT_TIMESTAMP, 
        NULL,  -- Public client, no secret (uses PKCE)
        NULL, 
        'Profile Admin Application', 
        'none',  -- Public client
        'authorization_code,refresh_token', 
        'http://localhost:8082/oauth/callback,http://localhost:8082/,https://profile-admin.example.com/oauth/callback', 
        'http://localhost:8082/,https://profile-admin.example.com/', 
        'openid,profile,email,profile:read,profile:write,profile:admin', 
            '{"@class":"java.util.Collections$UnmodifiableMap","settings.client.require-proof-key":true,"settings.client.require-authorization-consent":true}', 
            '{"@class":"java.util.Collections$UnmodifiableMap","settings.token.reuse-refresh-tokens":true,"settings.token.id-token-signature-algorithm":["org.springframework.security.oauth2.jose.jws.SignatureAlgorithm","ES256"],"settings.token.access-token-time-to-live":["java.time.Duration",3600.000000000],"settings.token.access-token-format":{"@class":"org.springframework.security.oauth2.server.authorization.settings.OAuth2TokenFormat","value":"self-contained"},"settings.token.refresh-token-time-to-live":["java.time.Duration",86400.000000000],"settings.token.authorization-code-time-to-live":["java.time.Duration",300.000000000]}'
    ) ON CONFLICT (client_id) DO UPDATE SET 
        scopes = EXCLUDED.scopes,
        redirect_uris = EXCLUDED.redirect_uris,
        post_logout_redirect_uris = EXCLUDED.post_logout_redirect_uris;

  V6__add_profile_service_client.sql: |
    -- Seed profile-service confidential client for profile service callbacks
    -- Uses Flyway placeholder profile_service_client_secret to avoid hard-coding secrets
    INSERT INTO oauth2_registered_client (
        id,
        client_id,
        client_id_issued_at,
        client_secret,
        client_secret_expires_at,
        client_name,
        client_authentication_methods,
        authorization_grant_types,
        redirect_uris,
        post_logout_redirect_uris,
        scopes,
        client_settings,
        token_settings
    ) VALUES (
        'profile-service-client-001',
        'profile-service',
        CURRENT_TIMESTAMP,
        '{noop}profile-service-placeholder-secret',
        NULL,
        'Profile Service',
        'client_secret_basic,client_secret_post',
        'authorization_code,refresh_token',
        'https://profile.cat-herding.net/_oauth2/callback',
        'https://profile.cat-herding.net/',
        'openid,profile,email,profile:read,profile:write',
        '{}',
        '{}'
    ) ON CONFLICT (client_id) DO UPDATE SET 
        client_authentication_methods = EXCLUDED.client_authentication_methods,
        authorization_grant_types = EXCLUDED.authorization_grant_types,
        redirect_uris = EXCLUDED.redirect_uris,
        post_logout_redirect_uris = EXCLUDED.post_logout_redirect_uris,
        scopes = EXCLUDED.scopes;

  V7__fix_profile_service_client_settings.sql: |
    -- Fix profile-service client settings that were missing @class type info and proper values
    -- This migration updates V6's client settings to include proper JSON with type markers

    UPDATE oauth2_registered_client 
    SET 
        client_settings = '{"@class":"java.util.Collections$UnmodifiableMap","settings.client.require-proof-key":false,"settings.client.require-authorization-consent":false}',
        token_settings = '{"@class":"java.util.Collections$UnmodifiableMap","settings.token.reuse-refresh-tokens":true,"settings.token.id-token-signature-algorithm":["org.springframework.security.oauth2.jose.jws.SignatureAlgorithm","ES256"],"settings.token.access-token-time-to-live":["java.time.Duration",3600.000000000],"settings.token.access-token-format":{"@class":"org.springframework.security.oauth2.server.authorization.settings.OAuth2TokenFormat","value":"self-contained"},"settings.token.refresh-token-time-to-live":["java.time.Duration",86400.000000000],"settings.token.authorization-code-time-to-live":["java.time.Duration",300.000000000]}'
    WHERE client_id = 'profile-service';

  V8__admin_clients_scopes_deny_rules.sql: |
    -- Admin-managed clients/scopes and flexible deny rules

    -- Client management metadata (do not replace oauth2_registered_client)
    CREATE TABLE IF NOT EXISTS oauth2_client_metadata (
        client_id VARCHAR(100) PRIMARY KEY,
        is_system BOOLEAN NOT NULL DEFAULT FALSE,
        enabled BOOLEAN NOT NULL DEFAULT TRUE,
        notes TEXT,
        created_by VARCHAR(255),
        created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
        CONSTRAINT fk_client_metadata_client_id
            FOREIGN KEY (client_id) REFERENCES oauth2_registered_client(client_id)
    );

    CREATE INDEX IF NOT EXISTS idx_client_metadata_enabled ON oauth2_client_metadata(enabled);
    CREATE INDEX IF NOT EXISTS idx_client_metadata_is_system ON oauth2_client_metadata(is_system);

    -- Manageable scope catalog
    CREATE TABLE IF NOT EXISTS oauth2_scope (
        scope VARCHAR(200) PRIMARY KEY,
        description TEXT,
        enabled BOOLEAN NOT NULL DEFAULT TRUE,
        is_system BOOLEAN NOT NULL DEFAULT FALSE,
        created_by VARCHAR(255),
        created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP
    );

    CREATE INDEX IF NOT EXISTS idx_oauth2_scope_enabled ON oauth2_scope(enabled);
    CREATE INDEX IF NOT EXISTS idx_oauth2_scope_is_system ON oauth2_scope(is_system);

    -- Client-to-scope assignment (normalized)
    CREATE TABLE IF NOT EXISTS oauth2_client_scope (
        client_id VARCHAR(100) NOT NULL,
        scope VARCHAR(200) NOT NULL,
        created_by VARCHAR(255),
        created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
        PRIMARY KEY (client_id, scope),
        CONSTRAINT fk_client_scope_client_id
            FOREIGN KEY (client_id) REFERENCES oauth2_registered_client(client_id),
        CONSTRAINT fk_client_scope_scope
            FOREIGN KEY (scope) REFERENCES oauth2_scope(scope)
    );

    CREATE INDEX IF NOT EXISTS idx_client_scope_client_id ON oauth2_client_scope(client_id);
    CREATE INDEX IF NOT EXISTS idx_client_scope_scope ON oauth2_client_scope(scope);

    -- System-wide deny list rules for disabling logins (supports exact and regex patterns)
    -- provider is nullable: NULL means apply to all providers
    CREATE TABLE IF NOT EXISTS security_deny_rule (
        id BIGSERIAL PRIMARY KEY,
        enabled BOOLEAN NOT NULL DEFAULT TRUE,
        provider VARCHAR(100),
        match_field VARCHAR(50) NOT NULL,
        match_type VARCHAR(20) NOT NULL,
        pattern TEXT NOT NULL,
        normalized_value VARCHAR(400),
        reason TEXT,
        created_by VARCHAR(255),
        created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP
    );

    CREATE INDEX IF NOT EXISTS idx_deny_rule_enabled ON security_deny_rule(enabled);
    CREATE INDEX IF NOT EXISTS idx_deny_rule_provider ON security_deny_rule(provider);
    CREATE INDEX IF NOT EXISTS idx_deny_rule_match_field ON security_deny_rule(match_field);
    CREATE INDEX IF NOT EXISTS idx_deny_rule_match_type ON security_deny_rule(match_type);
    CREATE INDEX IF NOT EXISTS idx_deny_rule_normalized_value ON security_deny_rule(normalized_value);

    COMMENT ON TABLE oauth2_client_metadata IS 'Admin-managed metadata for OAuth2 clients (system/non-system, enabled flag)';
    COMMENT ON TABLE oauth2_scope IS 'Admin-managed OAuth2 scope catalog';
    COMMENT ON TABLE oauth2_client_scope IS 'Normalized client-to-scope mapping';
    COMMENT ON TABLE security_deny_rule IS 'System-wide deny rules for blocking logins (supports provider-specific and global rules)';

  V9__seed_admin_tables_from_existing_clients.sql: |
    -- Seed admin-managed scope catalog and metadata from existing registered clients
    --
    -- This migration makes the admin UI usable immediately in environments where
    -- oauth2_registered_client is already populated (either by previous migrations
    -- or by provisioning scripts).

    -- 1) Ensure common system scopes exist
    INSERT INTO oauth2_scope (scope, description, enabled, is_system, created_by, created_at, updated_at)
    VALUES
        ('openid', 'OpenID Connect scope', true, true, 'system', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
        ('profile', 'OpenID Connect profile scope', true, true, 'system', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
        ('email', 'OpenID Connect email scope', true, true, 'system', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
        ('read', 'Demo read scope', true, true, 'system', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
        ('write', 'Demo write scope', true, true, 'system', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
        ('api:read', 'Machine-to-machine API read scope', true, true, 'system', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
        ('api:write', 'Machine-to-machine API write scope', true, true, 'system', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
        ('profile:read', 'Profile service read scope', true, true, 'system', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
        ('profile:write', 'Profile service write scope', true, true, 'system', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
    ON CONFLICT (scope) DO NOTHING;

    -- 2) Seed any scopes already present on registered clients (as system scopes)
    WITH existing_scopes AS (
        SELECT DISTINCT trim(s) AS scope
        FROM oauth2_registered_client rc
        CROSS JOIN LATERAL unnest(string_to_array(rc.scopes, ',')) s
        WHERE trim(s) <> ''
    )
    INSERT INTO oauth2_scope (scope, description, enabled, is_system, created_by, created_at, updated_at)
    SELECT es.scope, null, true, true, 'system', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
    FROM existing_scopes es
    ON CONFLICT (scope) DO NOTHING;

    -- 3) Seed metadata rows for existing clients (defaults to system+enabled)
    INSERT INTO oauth2_client_metadata (client_id, is_system, enabled, notes, created_by, created_at, updated_at)
    SELECT rc.client_id, true, true, 'Seeded for existing client', 'system', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
    FROM oauth2_registered_client rc
    ON CONFLICT (client_id) DO NOTHING;

    -- 4) Seed normalized client-to-scope mapping for existing clients
    INSERT INTO oauth2_client_scope (client_id, scope, created_by, created_at)
    SELECT rc.client_id, trim(s) AS scope, 'system', CURRENT_TIMESTAMP
    FROM oauth2_registered_client rc
    CROSS JOIN LATERAL unnest(string_to_array(rc.scopes, ',')) s
    WHERE trim(s) <> ''
    ON CONFLICT (client_id, scope) DO NOTHING;

  V10__add_github_review_service_client.sql: |
    -- Seed github-review-service confidential client for Envoy/Lua authorization-code token exchange
    --
    -- NOTE:
    -- - The Istio EnvoyFilter `github-review-oauth2-exchange` exchanges the authorization code by POSTing
    --   client_id/client_secret to /oauth2/token (client_secret_post).
    -- - The redirect_uri used by that filter is the application root: https://gh-review.cat-herding.net/
    --
    -- SECURITY:
    -- - Replace the placeholder secret with a real secret in BOTH the EnvoyFilter and this DB row.
    -- - Prefer storing an encoded secret (e.g., {bcrypt}...) in production.

    INSERT INTO oauth2_registered_client (
        id,
        client_id,
        client_id_issued_at,
        client_secret,
        client_secret_expires_at,
        client_name,
        client_authentication_methods,
        authorization_grant_types,
        redirect_uris,
        post_logout_redirect_uris,
        scopes,
        client_settings,
        token_settings
    ) VALUES (
        'github-review-service-client-001',
        'github-review-service',
        CURRENT_TIMESTAMP,
        '{noop}REPLACE_WITH_GITHUB_REVIEW_CLIENT_SECRET',
        NULL,
        'GitHub Review Service',
        'client_secret_post',
        'authorization_code,refresh_token',
        'https://gh-review.cat-herding.net/_oauth2/callback',
        'https://gh-review.cat-herding.net/',
        'openid,profile,email',
        '{"@class":"java.util.Collections$UnmodifiableMap","settings.client.require-proof-key":false,"settings.client.require-authorization-consent":false}',
        '{"@class":"java.util.Collections$UnmodifiableMap","settings.token.reuse-refresh-tokens":true,"settings.token.id-token-signature-algorithm":["org.springframework.security.oauth2.jose.jws.SignatureAlgorithm","ES256"],"settings.token.access-token-time-to-live":["java.time.Duration",3600.000000000],"settings.token.access-token-format":{"@class":"org.springframework.security.oauth2.server.authorization.settings.OAuth2TokenFormat","value":"self-contained"},"settings.token.refresh-token-time-to-live":["java.time.Duration",86400.000000000],"settings.token.authorization-code-time-to-live":["java.time.Duration",300.000000000]}'
    ) ON CONFLICT (client_id) DO UPDATE SET
        client_name = EXCLUDED.client_name,
        client_authentication_methods = EXCLUDED.client_authentication_methods,
        authorization_grant_types = EXCLUDED.authorization_grant_types,
        redirect_uris = EXCLUDED.redirect_uris,
        post_logout_redirect_uris = EXCLUDED.post_logout_redirect_uris,
        scopes = EXCLUDED.scopes,
        client_settings = EXCLUDED.client_settings,
        token_settings = EXCLUDED.token_settings;

    V11__update_github_review_service_client_secret.sql: |
        -- Update github-review-service confidential client secret to match the Istio EnvoyFilter Lua code-exchange filter.
        --
        -- NOTE:
        -- - V10 initially inserted a placeholder secret.
        -- - This migration updates the secret without modifying V10 (avoids Flyway checksum drift).
        --
        -- SECURITY:
        -- - This is a demo secret suitable for dev/test environments.
        -- - In production, replace this with a secret sourced from a proper secrets manager and
        --   store it encoded (e.g., {bcrypt}...).

        UPDATE oauth2_registered_client
        SET client_secret = '{noop}demo-github-review-client-secret'
        WHERE client_id = 'github-review-service';

    V12__update_profile_service_client_secret.sql: |
        -- Update profile-service client secret to use bcrypt encoding.
        -- The plaintext secret 'demo-profile-service-client-secret' is stored in Azure Key Vault
        -- and loaded via the CSI Secret Store driver. This migration stores the bcrypt hash.
        --
        -- SECURITY:
        -- - This is a demo secret suitable for dev/test environments.
        -- - In production, replace with a strong secret from Azure Key Vault.
        -- - The bcrypt hash was generated with: bcrypt.hashpw(b"demo-profile-service-client-secret", bcrypt.gensalt(rounds=10))

        UPDATE oauth2_registered_client
        SET client_secret = '{bcrypt}$2b$10$FBo7Qn2F/I4gwI7iJ0JYy.y9HGSY8Jo4r3n1mSgWZkGolZoMeaaUS'
        WHERE client_id = 'profile-service';

    V13__add_chat_service_client.sql: |
        -- Seed chat-service confidential client for Envoy authorization-code token exchange
        --
        -- The chat application will run at:
        --   https://chat.cat-herding.net
        -- and uses the same Envoy OAuth2 callback path:
        --   https://chat.cat-herding.net/_oauth2/callback
        --
        -- NOTE:
        -- - The Istio EnvoyFilter `chat-oauth2-exchange` exchanges the authorization code by POSTing
        --   client_id/client_secret to /oauth2/token (client_secret_post).
        --
        -- SECURITY:
        -- - V14 updates this placeholder secret to a demo value for dev/test.
        -- - In production, replace with a strong secret (stored in Azure Key Vault) and store it encoded (e.g., {bcrypt}...).

        INSERT INTO oauth2_registered_client (
                id,
                client_id,
                client_id_issued_at,
                client_secret,
                client_secret_expires_at,
                client_name,
                client_authentication_methods,
                authorization_grant_types,
                redirect_uris,
                post_logout_redirect_uris,
                scopes,
                client_settings,
                token_settings
        ) VALUES (
                'chat-service-client-001',
                'chat-service',
                CURRENT_TIMESTAMP,
                '{noop}REPLACE_WITH_CHAT_SERVICE_CLIENT_SECRET',
                NULL,
                'Chat Service',
                'client_secret_post',
                'authorization_code,refresh_token',
                'https://chat.cat-herding.net/_oauth2/callback',
                'https://chat.cat-herding.net/',
                'openid,profile,email',
                '{"@class":"java.util.Collections$UnmodifiableMap","settings.client.require-proof-key":false,"settings.client.require-authorization-consent":false}',
                '{"@class":"java.util.Collections$UnmodifiableMap","settings.token.reuse-refresh-tokens":true,"settings.token.id-token-signature-algorithm":["org.springframework.security.oauth2.jose.jws.SignatureAlgorithm","ES256"],"settings.token.access-token-time-to-live":["java.time.Duration",3600.000000000],"settings.token.access-token-format":{"@class":"org.springframework.security.oauth2.server.authorization.settings.OAuth2TokenFormat","value":"self-contained"},"settings.token.refresh-token-time-to-live":["java.time.Duration",86400.000000000],"settings.token.authorization-code-time-to-live":["java.time.Duration",300.000000000]}'
        ) ON CONFLICT (client_id) DO UPDATE SET
                client_name = EXCLUDED.client_name,
                client_authentication_methods = EXCLUDED.client_authentication_methods,
                authorization_grant_types = EXCLUDED.authorization_grant_types,
                redirect_uris = EXCLUDED.redirect_uris,
                post_logout_redirect_uris = EXCLUDED.post_logout_redirect_uris,
                scopes = EXCLUDED.scopes,
                client_settings = EXCLUDED.client_settings,
                token_settings = EXCLUDED.token_settings;

    V14__update_chat_service_client_secret.sql: |
        -- Update chat-service confidential client secret to a known demo value.
        --
        -- NOTE:
        -- - V13 initially inserted a placeholder secret.
        -- - This migration updates the secret without modifying V13 (avoids Flyway checksum drift).
        --
        -- SECURITY:
        -- - This is a demo secret suitable for dev/test environments.
        -- - In production, replace with a strong secret from Azure Key Vault and store it encoded (e.g., {bcrypt}...).

        UPDATE oauth2_registered_client
        SET client_secret = '{noop}demo-chat-service-client-secret'
        WHERE client_id = 'chat-service';
