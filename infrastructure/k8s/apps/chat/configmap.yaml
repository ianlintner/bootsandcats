apiVersion: v1
kind: ConfigMap
metadata:
  name: chat-backend-config
data:
  NODE_ENV: 'production'
  LOG_LEVEL: 'info'
  PORT: '5001'
  ENABLE_TRACING: 'false'
  ENABLE_METRICS: 'true'
  REDIS_HOST: 'redis-service'
  REDIS_PORT: '6379'
  API_URL: 'https://chat.cat-herding.net'
  FRONTEND_URL: 'https://chat.cat-herding.net'
  EXPO_PUBLIC_API_URL: 'https://chat.cat-herding.net'
  # Note: OAuth is handled at cluster level via oauth2-proxy

---
# Dedicated oauth2-proxy config for chat app (unique name ensures override of cluster-wide default)
apiVersion: v1
kind: ConfigMap
metadata:
  name: chat-oauth2-proxy-config
data:
  oauth2_proxy.cfg: |-
    http_address = "0.0.0.0:4180"
    provider = "github"
    email_domains = ["*"]
    upstreams = ["http://127.0.0.1:5001"]
    # OAuth callback URL for this specific app
    redirect_url = "https://chat.cat-herding.net/oauth2/callback"
    cookie_secure = true
    cookie_domains = [".cat-herding.net"]
    # cookie_samesite must be one of ['', 'lax', 'strict', 'none'] (lowercase per oauth2-proxy validation)
    cookie_samesite = "lax"
    # Explicitly disable minimal session to allow access/id tokens
    session_cookie_minimal = false
    set_authorization_header = true
    set_xauthrequest = true
    pass_access_token = true
    pass_authorization_header = true
    # Optionally expose user identity headers
    pass_user_headers = true
    # Skip auth for health and metrics endpoints
    skip_auth_routes = ["^/health$", "^/healthz$", "^/metrics$"]
    # GitHub scopes: read:user for profile, user:email for email, read:org for org membership (required by oauth2-proxy)
    scope = "read:user,user:email,read:org"
    # WebSocket upgrade support (required for Socket.io)
    proxy_websockets = true
    # Logging controls
    request_logging = true
    standard_logging = true
    silence_ping_logging = true
