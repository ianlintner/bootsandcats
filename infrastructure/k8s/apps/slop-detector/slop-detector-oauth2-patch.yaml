apiVersion: apps/v1
kind: Deployment
metadata:
  name: slop-detector
  namespace: default
spec:
  template:
    metadata:
      annotations:
        sidecar.istio.io/userVolumeMount: >-
          [{"name":"rendered-sds","mountPath":"/etc/istio/oauth2","readonly":true}]
    spec:
      initContainers:
      - name: render-sds-config
        image: busybox:1.37
        command: ["/bin/sh", "-c"]
        args:
        - |
          set -euo pipefail
          CLIENT_SECRET=$(cat /mnt/secrets-store/slop-detector-client-secret)
          HMAC_SECRET=$(cat /mnt/secrets-store/slop-detector-oauth-hmac-secret)

          cat > /etc/istio/oauth2/slop-detector-oauth-token.yaml <<EOF
          resources:
          - "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.Secret
            name: slop-detector-oauth-token
            generic_secret:
              secret:
                inline_string: "${CLIENT_SECRET}"
          EOF

          cat > /etc/istio/oauth2/slop-detector-oauth-hmac.yaml <<EOF
          resources:
          - "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.Secret
            name: slop-detector-oauth-hmac
            generic_secret:
              secret:
                inline_string: "${HMAC_SECRET}"
          EOF

          ls -la /etc/istio/oauth2
        volumeMounts:
        - name: secrets-store
          mountPath: "/mnt/secrets-store"
          readOnly: true
        - name: rendered-sds
          mountPath: "/etc/istio/oauth2"
      volumes:
      - name: rendered-sds
        emptyDir: {}
