apiVersion: v1
kind: ConfigMap
metadata:
  name: flyway-migrations
  namespace: default
  labels:
    app: oauth2-server
    component: database-migrations
data:
  V1__create_app_users_table.sql: |
    -- Create app_users table for federated identity users
    CREATE TABLE IF NOT EXISTS app_users (
        id BIGSERIAL PRIMARY KEY,
        username VARCHAR(255),
        email VARCHAR(255),
        provider VARCHAR(100) NOT NULL,
        provider_id VARCHAR(255) NOT NULL,
        name VARCHAR(255),
        picture_url TEXT,
        last_login TIMESTAMP,
        CONSTRAINT uq_provider_provider_id UNIQUE (provider, provider_id)
    );

    CREATE INDEX IF NOT EXISTS idx_app_users_email ON app_users(email);
    CREATE INDEX IF NOT EXISTS idx_app_users_username ON app_users(username);

  V2__create_oauth2_registered_client_table.sql: |
    CREATE TABLE IF NOT EXISTS oauth2_registered_client (
        id VARCHAR(100) PRIMARY KEY,
        client_id VARCHAR(100) NOT NULL UNIQUE,
        client_id_issued_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
        client_secret VARCHAR(200),
        client_secret_expires_at TIMESTAMP WITH TIME ZONE,
        client_name VARCHAR(200) NOT NULL,
        client_authentication_methods TEXT NOT NULL,
        authorization_grant_types TEXT NOT NULL,
        redirect_uris TEXT,
        post_logout_redirect_uris TEXT,
        scopes TEXT NOT NULL,
        client_settings TEXT NOT NULL,
        token_settings TEXT NOT NULL
    );

  V3__create_security_audit_table.sql: |
    -- Create security_audit_events table for compliance audit logging
    CREATE TABLE IF NOT EXISTS security_audit_events (
        id BIGSERIAL PRIMARY KEY,
        event_id UUID NOT NULL UNIQUE,
        event_type VARCHAR(100) NOT NULL,
        event_category VARCHAR(50) NOT NULL,
        event_timestamp TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
        
        -- Actor information
        principal VARCHAR(255),
        principal_type VARCHAR(50),
        user_id BIGINT,
        client_id VARCHAR(100),
        
        -- Request context
        ip_address VARCHAR(45),
        user_agent TEXT,
        request_uri TEXT,
        request_method VARCHAR(10),
        session_id VARCHAR(255),
        correlation_id VARCHAR(100),
        
        -- Event details
        result VARCHAR(20) NOT NULL,
        result_code VARCHAR(50),
        error_message TEXT,
        
        -- OAuth2 specific fields
        grant_type VARCHAR(50),
        scopes TEXT,
        token_type VARCHAR(50),
        authorization_code_id VARCHAR(255),
        
        -- Additional metadata as JSON
        details JSONB,
        
        -- Timestamps
        created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP
    );

    -- Performance indexes for common query patterns
    CREATE INDEX IF NOT EXISTS idx_audit_event_type ON security_audit_events(event_type);
    CREATE INDEX IF NOT EXISTS idx_audit_event_category ON security_audit_events(event_category);
    CREATE INDEX IF NOT EXISTS idx_audit_event_timestamp ON security_audit_events(event_timestamp);
    CREATE INDEX IF NOT EXISTS idx_audit_principal ON security_audit_events(principal);
    CREATE INDEX IF NOT EXISTS idx_audit_client_id ON security_audit_events(client_id);
    CREATE INDEX IF NOT EXISTS idx_audit_user_id ON security_audit_events(user_id);
    CREATE INDEX IF NOT EXISTS idx_audit_result ON security_audit_events(result);
    CREATE INDEX IF NOT EXISTS idx_audit_ip_address ON security_audit_events(ip_address);
    CREATE INDEX IF NOT EXISTS idx_audit_session_id ON security_audit_events(session_id);
    CREATE INDEX IF NOT EXISTS idx_audit_correlation_id ON security_audit_events(correlation_id);

    -- Composite index for time-range queries with filtering
    CREATE INDEX IF NOT EXISTS idx_audit_timestamp_type ON security_audit_events(event_timestamp, event_type);
    CREATE INDEX IF NOT EXISTS idx_audit_timestamp_principal ON security_audit_events(event_timestamp, principal);

    -- GIN index for JSON details field queries
    CREATE INDEX IF NOT EXISTS idx_audit_details ON security_audit_events USING GIN (details);

    -- Comment for documentation
    COMMENT ON TABLE security_audit_events IS 'Security audit log for OAuth2 compliance tracking';
    COMMENT ON COLUMN security_audit_events.event_id IS 'Unique identifier for the audit event (UUID)';
    COMMENT ON COLUMN security_audit_events.event_type IS 'Type of security event (e.g., LOGIN_SUCCESS, TOKEN_ISSUED)';
    COMMENT ON COLUMN security_audit_events.event_category IS 'Category grouping (e.g., AUTHENTICATION, TOKEN, AUTHORIZATION)';
    COMMENT ON COLUMN security_audit_events.result IS 'Event outcome: SUCCESS, FAILURE, DENIED';
    COMMENT ON COLUMN security_audit_events.details IS 'Additional event-specific metadata as JSON';

  V4__create_oauth2_authorization_tables.sql: |
    -- OAuth2 Authorization Table
    -- Stores authorization information (codes, tokens, etc.)
    CREATE TABLE IF NOT EXISTS oauth2_authorization (
        id VARCHAR(100) PRIMARY KEY,
        registered_client_id VARCHAR(100) NOT NULL,
        principal_name VARCHAR(200) NOT NULL,
        authorization_grant_type VARCHAR(100) NOT NULL,
        authorized_scopes TEXT,
        attributes TEXT,
        state VARCHAR(500),
        authorization_code_value TEXT,
        authorization_code_issued_at TIMESTAMP WITH TIME ZONE,
        authorization_code_expires_at TIMESTAMP WITH TIME ZONE,
        authorization_code_metadata TEXT,
        access_token_value TEXT,
        access_token_issued_at TIMESTAMP WITH TIME ZONE,
        access_token_expires_at TIMESTAMP WITH TIME ZONE,
        access_token_metadata TEXT,
        access_token_type VARCHAR(100),
        access_token_scopes TEXT,
        oidc_id_token_value TEXT,
        oidc_id_token_issued_at TIMESTAMP WITH TIME ZONE,
        oidc_id_token_expires_at TIMESTAMP WITH TIME ZONE,
        oidc_id_token_metadata TEXT,
        refresh_token_value TEXT,
        refresh_token_issued_at TIMESTAMP WITH TIME ZONE,
        refresh_token_expires_at TIMESTAMP WITH TIME ZONE,
        refresh_token_metadata TEXT,
        user_code_value TEXT,
        user_code_issued_at TIMESTAMP WITH TIME ZONE,
        user_code_expires_at TIMESTAMP WITH TIME ZONE,
        user_code_metadata TEXT,
        device_code_value TEXT,
        device_code_issued_at TIMESTAMP WITH TIME ZONE,
        device_code_expires_at TIMESTAMP WITH TIME ZONE,
        device_code_metadata TEXT,
        CONSTRAINT fk_oauth2_authorization_client 
            FOREIGN KEY (registered_client_id) REFERENCES oauth2_registered_client(id)
    );

    -- OAuth2 Authorization Consent Table
    -- Stores user consent for OAuth2 clients
    CREATE TABLE IF NOT EXISTS oauth2_authorization_consent (
        registered_client_id VARCHAR(100) NOT NULL,
        principal_name VARCHAR(200) NOT NULL,
        authorities TEXT NOT NULL,
        PRIMARY KEY (registered_client_id, principal_name),
        CONSTRAINT fk_oauth2_consent_client 
            FOREIGN KEY (registered_client_id) REFERENCES oauth2_registered_client(id)
    );

    -- Create indexes for common query patterns
    CREATE INDEX IF NOT EXISTS idx_oauth2_authorization_principal ON oauth2_authorization(principal_name);
    CREATE INDEX IF NOT EXISTS idx_oauth2_authorization_client ON oauth2_authorization(registered_client_id);
    CREATE INDEX IF NOT EXISTS idx_oauth2_authorization_state ON oauth2_authorization(state);

  V5__add_profile_ui_client.sql: |
    -- Add profile-ui client with profile scopes
    -- This client is used by the Profile UI application for managing user profiles

    -- Use INSERT ... ON CONFLICT to handle both id and client_id conflicts
    INSERT INTO oauth2_registered_client (
        id, 
        client_id, 
        client_id_issued_at, 
        client_secret, 
        client_secret_expires_at, 
        client_name, 
        client_authentication_methods, 
        authorization_grant_types, 
        redirect_uris, 
        post_logout_redirect_uris, 
        scopes, 
        client_settings, 
        token_settings
    ) VALUES (
        'profile-ui-client-001', 
        'profile-ui', 
        CURRENT_TIMESTAMP, 
        NULL,
        NULL, 
        'Profile UI Application', 
        'none',
        'authorization_code,refresh_token', 
        'http://localhost:8082/oauth/callback,http://localhost:8082/,https://profile-ui.example.com/oauth/callback', 
        'http://localhost:8082/,https://profile-ui.example.com/', 
        'openid,profile,email,profile:read,profile:write', 
        '{"@class":"java.util.Collections$UnmodifiableMap","settings.client.require-proof-key":true,"settings.client.require-authorization-consent":true}', 
        '{"@class":"java.util.Collections$UnmodifiableMap","settings.token.reuse-refresh-tokens":true,"settings.token.id-token-signature-algorithm":["org.springframework.security.oauth2.jose.jws.SignatureAlgorithm","ES256"],"settings.token.access-token-time-to-live":["java.time.Duration",3600.000000000],"settings.token.access-token-format":{"@class":"org.springframework.security.oauth2.server.authorization.settings.OAuth2TokenFormat","value":"self-contained"},"settings.token.refresh-token-time-to-live":["java.time.Duration",86400.000000000],"settings.token.authorization-code-time-to-live":["java.time.Duration",300.000000000]}'
    ) ON CONFLICT (client_id) DO UPDATE SET 
        scopes = EXCLUDED.scopes,
        redirect_uris = EXCLUDED.redirect_uris,
        post_logout_redirect_uris = EXCLUDED.post_logout_redirect_uris;

      V6__add_profile_service_client.sql: |
      -- Seed profile-service confidential client for profile service callbacks
      INSERT INTO oauth2_registered_client (
        id,
        client_id,
        client_id_issued_at,
        client_secret,
        client_secret_expires_at,
        client_name,
        client_authentication_methods,
        authorization_grant_types,
        redirect_uris,
        post_logout_redirect_uris,
        scopes,
        client_settings,
        token_settings
      ) VALUES (
        'profile-service-client-001',
        'profile-service',
        CURRENT_TIMESTAMP,
        '{noop}profile-service-placeholder-secret',
        NULL,
        'Profile Service',
        'client_secret_basic,client_secret_post',
        'authorization_code,refresh_token',
        'https://profile.cat-herding.net/',
        'https://profile.cat-herding.net/',
        'openid,profile,email,profile:read,profile:write',
        '{}',
        '{}'
      ) ON CONFLICT (client_id) DO UPDATE SET 
        client_authentication_methods = EXCLUDED.client_authentication_methods,
        authorization_grant_types = EXCLUDED.authorization_grant_types,
        redirect_uris = EXCLUDED.redirect_uris,
        post_logout_redirect_uris = EXCLUDED.post_logout_redirect_uris,
        scopes = EXCLUDED.scopes;

    -- Also add an admin client for admin users
    INSERT INTO oauth2_registered_client (
        id, 
        client_id, 
        client_id_issued_at, 
        client_secret, 
        client_secret_expires_at, 
        client_name, 
        client_authentication_methods, 
        authorization_grant_types, 
        redirect_uris, 
        post_logout_redirect_uris, 
        scopes, 
        client_settings, 
        token_settings
    ) VALUES (
        'profile-admin-client-001', 
        'profile-admin', 
        CURRENT_TIMESTAMP, 
        NULL,
        NULL, 
        'Profile Admin Application', 
        'none',
        'authorization_code,refresh_token', 
        'http://localhost:8082/oauth/callback,http://localhost:8082/,https://profile-admin.example.com/oauth/callback', 
        'http://localhost:8082/,https://profile-admin.example.com/', 
        'openid,profile,email,profile:read,profile:write,profile:admin', 
        '{"@class":"java.util.Collections$UnmodifiableMap","settings.client.require-proof-key":true,"settings.client.require-authorization-consent":true}', 
        '{"@class":"java.util.Collections$UnmodifiableMap","settings.token.reuse-refresh-tokens":true,"settings.token.id-token-signature-algorithm":["org.springframework.security.oauth2.jose.jws.SignatureAlgorithm","ES256"],"settings.token.access-token-time-to-live":["java.time.Duration",3600.000000000],"settings.token.access-token-format":{"@class":"org.springframework.security.oauth2.server.authorization.settings.OAuth2TokenFormat","value":"self-contained"},"settings.token.refresh-token-time-to-live":["java.time.Duration",86400.000000000],"settings.token.authorization-code-time-to-live":["java.time.Duration",300.000000000]}'
    ) ON CONFLICT (client_id) DO UPDATE SET 
        scopes = EXCLUDED.scopes,
        redirect_uris = EXCLUDED.redirect_uris,
        post_logout_redirect_uris = EXCLUDED.post_logout_redirect_uris;
