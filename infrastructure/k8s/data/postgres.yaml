# CloudNativePG PostgreSQL Cluster
# Documentation: https://cloudnative-pg.io/documentation/1.19/
# Requires: kubectl apply -f https://raw.githubusercontent.com/cloudnative-pg/cloudnative-pg/release-1.19/releases/cnpg-1.19.6.yaml

---
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: default
  labels:
    app: postgres-ha
spec:
  type: ClusterIP
  ports:
  - name: tcp-postgres
    port: 5432
    targetPort: 5432
  selector:
    cnpg.io/cluster: postgres-ha
    role: primary

---
apiVersion: v1
kind: Service
metadata:
  name: postgres-ro
  namespace: default
  labels:
    app: postgres-ha
spec:
  type: ClusterIP
  ports:
  - name: tcp-postgres
    port: 5432
    targetPort: 5432
  selector:
    cnpg.io/cluster: postgres-ha
    role: replica

---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: postgres-ha
  namespace: default
  labels:
    app: postgres-ha
spec:
  instances: 2

  # PostgreSQL 15
  imageName: ghcr.io/cloudnative-pg/postgresql:15.8

  # Primary update strategy
  primaryUpdateStrategy: unsupervised

  # NOTE: CloudNativePG operator talks directly to each instance's local HTTP status endpoint
  # (podIP:8000, e.g. /pg/status). If an Istio sidecar is injected, Envoy can intercept that
  # traffic and reset the connection (especially when the operator is not in the mesh and/or
  # strict mTLS is enabled). Keep sidecar injection disabled for CNPG-managed PostgreSQL pods.
  inheritedMetadata:
    annotations:
      sidecar.istio.io/inject: "true"

  # Bootstrap from scratch with initial database
  bootstrap:
    initdb:
      database: oauth2db
      owner: oauth2user
      secret:
        name: oauth2-cnpg-credentials
      postInitSQL:
        - CREATE EXTENSION IF NOT EXISTS "uuid-ossp"

  # Use credentials from existing secret
  superuserSecret:
    name: postgres-superuser-secret

  # Storage configuration
  storage:
    # NOTE: PVCs cannot be shrunk; keep this >= the currently-provisioned size in the cluster.
    size: 4Gi
    storageClass: managed-premium

  # Tolerate spot instances
  affinity:
    enablePodAntiAffinity: true
    topologyKey: kubernetes.io/hostname
    podAntiAffinityType: preferred
    tolerations:
      - key: kubernetes.azure.com/scalesetpriority
        operator: Equal
        value: spot
        effect: NoSchedule

  # PostgreSQL configuration
  postgresql:
    parameters:
      shared_buffers: "128MB"
      max_connections: "100"
      log_statement: "ddl"
    pg_hba:
      - host all all 10.0.0.0/8 scram-sha-256
      - host all all 172.16.0.0/12 scram-sha-256
      - host all all 192.168.0.0/16 scram-sha-256

# Note: The following secrets should be created manually or via sealed-secrets/external-secrets:
# - postgres-superuser-secret (keys: username, password)
# - oauth2-cnpg-credentials (keys: username, password) - mapped from oauth2-app-secrets
