# Template: per-workload OAuth2 client secrets from Azure Key Vault
#
# Recommended approach:
# - Keep ONE central Key Vault (e.g., inker-kv) containing all OAuth2 client secrets.
# - Create ONE SecretProviderClass per workload (profile-service, chat-backend, github-review-service, etc.)
#   that references ONLY the objects that workload needs.
#
# Usage:
# - Copy this file, rename it, and adjust:
#   - metadata.name
#   - secretObjects.secretName (namespace-scoped Kubernetes Secret)
#   - objects list
# - Reference it from your Deployment via CSI volumeAttributes.secretProviderClass.
#
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: oauth2-client-secrets-provider-TEMPLATE
  namespace: default
spec:
  provider: azure
  # Optional: sync into a Kubernetes Secret for env var refs.
  # Keep this Secret SMALL and workload-specific.
  secretObjects:
    - secretName: oauth2-client-secrets-TEMPLATE
      type: Opaque
      data:
        # Example: confidential client secret used for token exchange
        - objectName: oauth2-client-TEMPLATE-secret
          key: client-secret
        # Example: HMAC signing secret used by Envoy Lua/JWT glue
        - objectName: oauth2-client-TEMPLATE-hmac
          key: oauth-hmac-secret
  parameters:
    # NOTE: This repo currently uses VM managed identity (useVMManagedIdentity) + userAssignedIdentityID.
    # If/when you move to AKS Workload Identity, these parameters will change.
    usePodIdentity: "false"
    useVMManagedIdentity: "true"
    userAssignedIdentityID: "REPLACE-WITH-IDENTITY-CLIENT-ID"

    keyvaultName: inker-kv
    tenantId: "REPLACE-WITH-TENANT-ID"

    objects: |
      array:
        - |
          objectName: oauth2-client-TEMPLATE-secret
          objectType: secret
        - |
          objectName: oauth2-client-TEMPLATE-hmac
          objectType: secret
