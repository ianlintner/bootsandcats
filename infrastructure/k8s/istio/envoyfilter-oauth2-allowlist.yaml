apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: oauth2-allowlist
  namespace: aks-istio-ingress
spec:
  workloadSelector:
    labels:
      istio: aks-istio-ingressgateway-external

  # Opt-in OAuth2 enforcement for non-secure hosts.
  #
  # How this works:
  # - The base filter (`envoyfilter-secure-subdomain-oauth2.yaml`) installs the OAuth2 filter
  #   but disables enforcement by default on all gateway virtual hosts.
  # - This allowlist filter enables enforcement for explicitly listed virtual hosts.
  #
  # Add hosts by duplicating a configPatch and setting `vhost.name` to "<host>:443".
  # Example:
  # - name: "profile.cat-herding.net:443"
  # - name: "slop-detector.cat-herding.net:443"
  configPatches:
    # ---- Allowlisted host entries (prod) ----

    # Secure namespace wildcard (protect all apps under *.secure.cat-herding.net)
    - applyTo: VIRTUAL_HOST
      match:
        context: GATEWAY
        routeConfiguration:
          vhost:
            name: "*.secure.cat-herding.net:443"
            route:
              name: ""
      patch:
        operation: MERGE
        value:
          typed_per_filter_config:
            envoy.filters.http.oauth2:
              "@type": type.googleapis.com/envoy.extensions.filters.http.oauth2.v3.OAuth2
              config:
                stat_prefix: secure_subdomain_oauth
                authorization_endpoint: https://oauth2.cat-herding.net/oauth2/authorize
                token_endpoint:
                  cluster: oauth2_token_cluster_secure_subdomain
                  uri: https://oauth2-server.default.svc.cluster.local:9000/oauth2/token
                  timeout: 5s
                redirect_uri: "%REQ(x-forwarded-proto)%://%REQ(:authority)%/_oauth2/callback"
                redirect_path_matcher:
                  path:
                    prefix: /_oauth2/callback
                signout_path:
                  path:
                    prefix: /_oauth2/logout
                forward_bearer_token: true
                default_expires_in: 900s
                csrf_token_expires_in: 600s
                credentials:
                  client_id: secure-subdomain-client
                  token_secret:
                    name: secure-subdomain-oauth-token
                    sds_config:
                      path: /etc/istio/oauth2/secure-subdomain-oauth-token.yaml
                  hmac_secret:
                    name: secure-subdomain-oauth-hmac
                    sds_config:
                      path: /etc/istio/oauth2/secure-subdomain-oauth-hmac.yaml
                  cookie_domain: ".cat-herding.net"
                  cookie_names:
                    bearer_token: "_secure_session"
                    oauth_hmac: "_secure_oauth_hmac"
                    oauth_expires: "_secure_oauth_expires"
                cookie_configs:
                  bearer_token_cookie_config:
                    same_site: LAX
                  oauth_hmac_cookie_config:
                    same_site: LAX
                  oauth_expires_cookie_config:
                    same_site: LAX
                auth_scopes:
                - openid
                - profile
                - email
                pass_through_matcher:
                - name: ":authority"
                  exact_match: "oauth2.cat-herding.net"
                - name: ":path"
                  prefix_match: "/actuator"
                - name: ":path"
                  exact_match: "/health"
                - name: ":path"
                  exact_match: "/healthz"
                - name: ":path"
                  exact_match: "/ready"

    # Explicit allowlist for normal hosts
    - applyTo: VIRTUAL_HOST
      match:
        context: GATEWAY
        routeConfiguration:
          vhost:
            name: "profile.cat-herding.net:443"
            route:
              name: ""
      patch:
        operation: MERGE
        value:
          typed_per_filter_config:
            envoy.filters.http.oauth2:
              "@type": type.googleapis.com/envoy.extensions.filters.http.oauth2.v3.OAuth2
              config:
                stat_prefix: secure_subdomain_oauth
                authorization_endpoint: https://oauth2.cat-herding.net/oauth2/authorize
                token_endpoint:
                  cluster: oauth2_token_cluster_secure_subdomain
                  uri: https://oauth2-server.default.svc.cluster.local:9000/oauth2/token
                  timeout: 5s
                redirect_uri: "%REQ(x-forwarded-proto)%://%REQ(:authority)%/_oauth2/callback"
                redirect_path_matcher:
                  path:
                    prefix: /_oauth2/callback
                signout_path:
                  path:
                    prefix: /_oauth2/logout
                forward_bearer_token: true
                default_expires_in: 900s
                csrf_token_expires_in: 600s
                credentials:
                  client_id: secure-subdomain-client
                  token_secret:
                    name: secure-subdomain-oauth-token
                    sds_config:
                      path: /etc/istio/oauth2/secure-subdomain-oauth-token.yaml
                  hmac_secret:
                    name: secure-subdomain-oauth-hmac
                    sds_config:
                      path: /etc/istio/oauth2/secure-subdomain-oauth-hmac.yaml
                  cookie_domain: ".cat-herding.net"
                  cookie_names:
                    bearer_token: "_secure_session"
                    oauth_hmac: "_secure_oauth_hmac"
                    oauth_expires: "_secure_oauth_expires"
                cookie_configs:
                  bearer_token_cookie_config:
                    same_site: LAX
                  oauth_hmac_cookie_config:
                    same_site: LAX
                  oauth_expires_cookie_config:
                    same_site: LAX
                auth_scopes:
                - openid
                - profile
                - email
                pass_through_matcher:
                - name: ":authority"
                  exact_match: "oauth2.cat-herding.net"
                - name: ":path"
                  prefix_match: "/actuator"
                - name: ":path"
                  exact_match: "/health"
                - name: ":path"
                  exact_match: "/healthz"
                - name: ":path"
                  exact_match: "/ready"

    - applyTo: VIRTUAL_HOST
      match:
        context: GATEWAY
        routeConfiguration:
          vhost:
            name: "gh-review.cat-herding.net:443"
            route:
              name: ""
      patch:
        operation: MERGE
        value:
          typed_per_filter_config:
            envoy.filters.http.oauth2:
              "@type": type.googleapis.com/envoy.extensions.filters.http.oauth2.v3.OAuth2
              config:
                stat_prefix: secure_subdomain_oauth
                authorization_endpoint: https://oauth2.cat-herding.net/oauth2/authorize
                token_endpoint:
                  cluster: oauth2_token_cluster_secure_subdomain
                  uri: https://oauth2-server.default.svc.cluster.local:9000/oauth2/token
                  timeout: 5s
                redirect_uri: "%REQ(x-forwarded-proto)%://%REQ(:authority)%/_oauth2/callback"
                redirect_path_matcher:
                  path:
                    prefix: /_oauth2/callback
                signout_path:
                  path:
                    prefix: /_oauth2/logout
                forward_bearer_token: true
                default_expires_in: 900s
                csrf_token_expires_in: 600s
                credentials:
                  client_id: secure-subdomain-client
                  token_secret:
                    name: secure-subdomain-oauth-token
                    sds_config:
                      path: /etc/istio/oauth2/secure-subdomain-oauth-token.yaml
                  hmac_secret:
                    name: secure-subdomain-oauth-hmac
                    sds_config:
                      path: /etc/istio/oauth2/secure-subdomain-oauth-hmac.yaml
                  cookie_domain: ".cat-herding.net"
                  cookie_names:
                    bearer_token: "_secure_session"
                    oauth_hmac: "_secure_oauth_hmac"
                    oauth_expires: "_secure_oauth_expires"
                cookie_configs:
                  bearer_token_cookie_config:
                    same_site: LAX
                  oauth_hmac_cookie_config:
                    same_site: LAX
                  oauth_expires_cookie_config:
                    same_site: LAX
                auth_scopes:
                - openid
                - profile
                - email
                pass_through_matcher:
                - name: ":authority"
                  exact_match: "oauth2.cat-herding.net"
                - name: ":path"
                  prefix_match: "/actuator"
                - name: ":path"
                  exact_match: "/health"
                - name: ":path"
                  exact_match: "/healthz"
                - name: ":path"
                  exact_match: "/ready"

    - applyTo: VIRTUAL_HOST
      match:
        context: GATEWAY
        routeConfiguration:
          vhost:
            name: "slop-detector.cat-herding.net:443"
            route:
              name: ""
      patch:
        operation: MERGE
        value:
          typed_per_filter_config:
            envoy.filters.http.oauth2:
              "@type": type.googleapis.com/envoy.extensions.filters.http.oauth2.v3.OAuth2
              config:
                stat_prefix: secure_subdomain_oauth
                authorization_endpoint: https://oauth2.cat-herding.net/oauth2/authorize
                token_endpoint:
                  cluster: oauth2_token_cluster_secure_subdomain
                  uri: https://oauth2-server.default.svc.cluster.local:9000/oauth2/token
                  timeout: 5s
                redirect_uri: "%REQ(x-forwarded-proto)%://%REQ(:authority)%/_oauth2/callback"
                redirect_path_matcher:
                  path:
                    prefix: /_oauth2/callback
                signout_path:
                  path:
                    prefix: /_oauth2/logout
                forward_bearer_token: true
                default_expires_in: 900s
                csrf_token_expires_in: 600s
                credentials:
                  client_id: secure-subdomain-client
                  token_secret:
                    name: secure-subdomain-oauth-token
                    sds_config:
                      path: /etc/istio/oauth2/secure-subdomain-oauth-token.yaml
                  hmac_secret:
                    name: secure-subdomain-oauth-hmac
                    sds_config:
                      path: /etc/istio/oauth2/secure-subdomain-oauth-hmac.yaml
                  cookie_domain: ".cat-herding.net"
                  cookie_names:
                    bearer_token: "_secure_session"
                    oauth_hmac: "_secure_oauth_hmac"
                    oauth_expires: "_secure_oauth_expires"
                cookie_configs:
                  bearer_token_cookie_config:
                    same_site: LAX
                  oauth_hmac_cookie_config:
                    same_site: LAX
                  oauth_expires_cookie_config:
                    same_site: LAX
                auth_scopes:
                - openid
                - profile
                - email
                pass_through_matcher:
                - name: ":authority"
                  exact_match: "oauth2.cat-herding.net"
                - name: ":path"
                  prefix_match: "/actuator"
                - name: ":path"
                  exact_match: "/health"
                - name: ":path"
                  exact_match: "/healthz"
                - name: ":path"
                  exact_match: "/ready"

    - applyTo: VIRTUAL_HOST
      match:
        context: GATEWAY
        routeConfiguration:
          vhost:
            name: "security-agency.cat-herding.net:443"
            route:
              name: ""
      patch:
        operation: MERGE
        value:
          typed_per_filter_config:
            envoy.filters.http.oauth2:
              "@type": type.googleapis.com/envoy.extensions.filters.http.oauth2.v3.OAuth2
              config:
                stat_prefix: secure_subdomain_oauth
                authorization_endpoint: https://oauth2.cat-herding.net/oauth2/authorize
                token_endpoint:
                  cluster: oauth2_token_cluster_secure_subdomain
                  uri: https://oauth2-server.default.svc.cluster.local:9000/oauth2/token
                  timeout: 5s
                redirect_uri: "%REQ(x-forwarded-proto)%://%REQ(:authority)%/_oauth2/callback"
                redirect_path_matcher:
                  path:
                    prefix: /_oauth2/callback
                signout_path:
                  path:
                    prefix: /_oauth2/logout
                forward_bearer_token: true
                default_expires_in: 900s
                csrf_token_expires_in: 600s
                credentials:
                  client_id: secure-subdomain-client
                  token_secret:
                    name: secure-subdomain-oauth-token
                    sds_config:
                      path: /etc/istio/oauth2/secure-subdomain-oauth-token.yaml
                  hmac_secret:
                    name: secure-subdomain-oauth-hmac
                    sds_config:
                      path: /etc/istio/oauth2/secure-subdomain-oauth-hmac.yaml
                  cookie_domain: ".cat-herding.net"
                  cookie_names:
                    bearer_token: "_secure_session"
                    oauth_hmac: "_secure_oauth_hmac"
                    oauth_expires: "_secure_oauth_expires"
                cookie_configs:
                  bearer_token_cookie_config:
                    same_site: LAX
                  oauth_hmac_cookie_config:
                    same_site: LAX
                  oauth_expires_cookie_config:
                    same_site: LAX
                auth_scopes:
                - openid
                - profile
                - email
                pass_through_matcher:
                - name: ":authority"
                  exact_match: "oauth2.cat-herding.net"
                - name: ":path"
                  prefix_match: "/actuator"
                - name: ":path"
                  exact_match: "/health"
                - name: ":path"
                  exact_match: "/healthz"
                - name: ":path"
                  exact_match: "/ready"
