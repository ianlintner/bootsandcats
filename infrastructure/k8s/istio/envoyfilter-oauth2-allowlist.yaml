apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: oauth2-allowlist
  namespace: aks-istio-ingress
spec:
  workloadSelector:
    labels:
      istio: aks-istio-ingressgateway-external

  # Opt-in OAuth2 enforcement for non-secure hosts.
  #
  # How this works:
  # - The base filter (`envoyfilter-secure-subdomain-oauth2.yaml`) installs the OAuth2 filter
  #   but disables enforcement by default on all gateway virtual hosts.
  # - This allowlist filter enables enforcement for explicitly listed virtual hosts.
  #
  # Add hosts by duplicating a configPatch and setting `vhost.name` to "<host>:443".
  # Example:
  # - name: "profile.cat-herding.net:443"
  # - name: "slop-detector.cat-herding.net:443"
  configPatches:
    # ---- Allowlisted host entries (prod) ----

    # Secure namespace wildcard (protect all apps under *.secure.cat-herding.net)
    - applyTo: VIRTUAL_HOST
      match:
        context: GATEWAY
        routeConfiguration:
          vhost:
            name: "*.secure.cat-herding.net:443"
            route:
              name: ""
      patch:
        operation: MERGE
        value:
          per_filter_config:
            envoy.filters.http.oauth2:
              disabled: false

    # Explicit allowlist for normal hosts
    - applyTo: VIRTUAL_HOST
      match:
        context: GATEWAY
        routeConfiguration:
          vhost:
            name: "profile.cat-herding.net:443"
            route:
              name: ""
      patch:
        operation: MERGE
        value:
          per_filter_config:
            envoy.filters.http.oauth2:
              disabled: false

    - applyTo: VIRTUAL_HOST
      match:
        context: GATEWAY
        routeConfiguration:
          vhost:
            name: "gh-review.cat-herding.net:443"
            route:
              name: ""
      patch:
        operation: MERGE
        value:
          per_filter_config:
            envoy.filters.http.oauth2:
              disabled: false

    - applyTo: VIRTUAL_HOST
      match:
        context: GATEWAY
        routeConfiguration:
          vhost:
            name: "slop-detector.cat-herding.net:443"
            route:
              name: ""
      patch:
        operation: MERGE
        value:
          per_filter_config:
            envoy.filters.http.oauth2:
              disabled: false

    - applyTo: VIRTUAL_HOST
      match:
        context: GATEWAY
        routeConfiguration:
          vhost:
            name: "security-agency.cat-herding.net:443"
            route:
              name: ""
      patch:
        operation: MERGE
        value:
          per_filter_config:
            envoy.filters.http.oauth2:
              disabled: false
