# Istio Authorization Policies for the default namespace
# Allows all traffic within the namespace (service mesh)

---
# Allow all traffic from workloads within the default namespace
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-intra-namespace
  namespace: default
  labels:
    app.kubernetes.io/managed-by: kustomize
    project: bootsandcats
spec:
  action: ALLOW
  rules:
  - from:
    - source:
        namespaces:
        - default

---
# Allow traffic from Istio ingress gateway (external traffic)
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-istio-ingress-authenticated
  namespace: default
  labels:
    app.kubernetes.io/managed-by: kustomize
    project: bootsandcats
spec:
  action: ALLOW
  rules:
  - from:
    - source:
        namespaces:
        - aks-istio-ingress
        requestPrincipals:
        - "*"

---
# Allow unauthenticated ingress traffic to the OAuth2 server itself.
#
# The ingress gateway performs token exchange by calling /oauth2/token on oauth2-server.
# Those calls (and the public OAuth2/OIDC endpoints) do not have an end-user JWT.
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-istio-ingress-to-oauth2-server
  namespace: default
  labels:
    app.kubernetes.io/managed-by: kustomize
    project: bootsandcats
spec:
  selector:
    matchLabels:
      app: oauth2-server
  action: ALLOW
  rules:
  - from:
    - source:
        namespaces:
        - aks-istio-ingress
    to:
    - operation:
        ports:
        - "9000"

---
# Allow health checks and probes (unauthenticated)
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-health-checks
  namespace: default
  labels:
    app.kubernetes.io/managed-by: kustomize
    project: bootsandcats
spec:
  action: ALLOW
  rules:
  - to:
    - operation:
        paths:
        - "/actuator/health/*"
        - "/actuator/health"
        - "/health"
        - "/healthz"
        - "/ready"
        - "/readyz"
        - "/livez"

---
# Specific policy for oauth2-server to access Redis and Postgres
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: oauth2-server-backend-access
  namespace: default
  labels:
    app.kubernetes.io/managed-by: kustomize
    project: bootsandcats
spec:
  selector:
    matchLabels:
      app: redis
  action: ALLOW
  rules:
  - from:
    - source:
        principals:
        - cluster.local/ns/default/sa/default
        - cluster.local/ns/default/sa/oauth2-server
    to:
    - operation:
        ports:
        - "6379"

---
# Allow oauth2-server to access PostgreSQL
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: postgres-access
  namespace: default
  labels:
    app.kubernetes.io/managed-by: kustomize
    project: bootsandcats
spec:
  selector:
    matchLabels:
      cnpg.io/cluster: postgres-ha
  action: ALLOW
  rules:
  - to:
    - operation:
        ports:
        - "5432"
        - "8000"

---
# Allow oauth2-server to access its own endpoints
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: oauth2-server-endpoint-access
  namespace: default
  labels:
    app.kubernetes.io/managed-by: kustomize
    project: bootsandcats
spec:
  action: ALLOW
  rules:
  - from:
    - source:
        principals:
        - "cluster.local/ns/default/sa/oauth2-server"
    to:
    - operation:
        methods: ["GET", "POST"]
        paths: ["/oauth2/*"]

---
# Allow profile-service to complete the OAuth flow and serve static assets via the gateway
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: profile-service-frontend-access
  namespace: default
  labels:
    app.kubernetes.io/managed-by: kustomize
    project: bootsandcats
spec:
  selector:
    matchLabels:
      app: profile-service
  action: ALLOW
  rules:
  - from:
    - source:
        principals:
        - cluster.local/ns/aks-istio-ingress/sa/istio-ingressgateway-service-account
        - cluster.local/ns/default/sa/oauth2-server
    to:
    - operation:
        methods: ["GET", "POST"]
        paths:
        - "/_oauth2/callback"
        - "/_oauth2/logout"
        - "/favicon.ico"
        - "/profile-app.js"
        - "/index.html"
        - "/swagger"
        - "/swagger/*"
        - "/openapi"
        - "/openapi/*"
        - "/css/*"
        - "/js/*"
        - "/images/*"

---
# Allow profile-service to reach the OAuth2 server for token exchanges
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: oauth2-server-profile-service-access
  namespace: default
  labels:
    app.kubernetes.io/managed-by: kustomize
    project: bootsandcats
spec:
  selector:
    matchLabels:
      app: oauth2-server
  action: ALLOW
  rules:
  - from:
    - source:
        principals:
        - cluster.local/ns/default/sa/default
    to:
    - operation:
        ports:
        - "9000"
