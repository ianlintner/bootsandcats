apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# This overlay patches the chat-backend deployment to add an init container
# that renders OAuth2 SDS files from CSI-mounted secrets

patchesJson6902:
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: chat-backend
      namespace: default
    patch: |-
      - op: add
        path: /spec/template/spec/initContainers
        value:
          - name: init-oauth-sds
            image: busybox:1.37
            command:
              - /bin/sh
              - -c
              - |
                set -e
                echo "Initializing OAuth2 SDS files..."
                
                # Create output directory
                mkdir -p /etc/istio/oauth2
                
                # Read the secrets from the CSI mount
                CLIENT_SECRET=$(cat /mnt/secrets-store/chat-client-secret)
                HMAC_SECRET=$(cat /mnt/secrets-store/chat-oauth-hmac-secret)
                
                # Render SDS file for token secret
                cat > /etc/istio/oauth2/chat-oauth-token.yaml <<'EOF'
                resources:
                - name: chat-oauth-token
                  secret:
                    inline_string: "$CLIENT_SECRET"
                EOF
                
                # Render SDS file for HMAC secret
                cat > /etc/istio/oauth2/chat-oauth-hmac.yaml <<'EOF'
                resources:
                - name: chat-oauth-hmac
                  secret:
                    inline_string: "$HMAC_SECRET"
                EOF
                
                echo "OAuth2 SDS files initialized successfully"
                ls -la /etc/istio/oauth2/
            volumeMounts:
              - name: secrets-store
                mountPath: /mnt/secrets-store
                readOnly: true
              - name: istio-oauth2
                mountPath: /etc/istio/oauth2
      - op: add
        path: /spec/template/spec/volumes
        value:
          - name: istio-oauth2
            emptyDir: {}
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts
        value:
          - name: istio-oauth2
            mountPath: /etc/istio/oauth2
            readOnly: true
